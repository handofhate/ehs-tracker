<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Job Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --bg2: #161820;
    --bg3: #1e2028;
    --border: #2a2d3a;
    --border2: #363a4a;
    --text: #e8eaf0;
    --text2: #9095a8;
    --text3: #5a5f72;
    --accent: #f5a623;
    --accent2: #e8941a;
    --green: #4caf82;
    --yellow: #f0c040;
    --red: #e05c5c;
    --blue: #5b8def;
    --purple: #9b7fe8;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; font-size: 18px; }

  .header { background: var(--bg2); border-bottom: 2px solid var(--accent); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .header-title { font-family: var(--mono); font-size: 22px; font-weight: 600; letter-spacing: 0.05em; color: var(--accent); }
  .header-title span { color: var(--text2); font-weight: 400; }
  .header-actions { display: flex; gap: 10px; align-items: center; }

  .btn { font-family: var(--mono); font-size: 16px; font-weight: 500; letter-spacing: 0.05em; padding: 8px 16px; border: none; cursor: pointer; border-radius: 3px; transition: all 0.15s; text-transform: uppercase; }
  .btn-primary { background: var(--accent); color: #0f1117; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border2); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
  .btn-danger:hover { background: var(--red); color: white; }
  .btn-green { background: var(--green); color: #0f1117; }
  .btn-green:hover { opacity: 0.85; }
  .btn-sm { padding: 5px 10px; font-size: 15px; }

  .main { padding: 24px; max-width: 1200px; margin: 0 auto; }

  .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 28px; }
  .summary-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; padding: 16px; }
  .summary-label { font-family: var(--mono); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 8px; }
  .summary-value { font-family: var(--mono); font-size: 26px; font-weight: 600; color: var(--text); }
  .summary-value.green { color: var(--green); }
  .summary-value.orange { color: var(--accent); }
  .summary-value.red { color: var(--red); }
  .summary-sub { font-size: 15px; color: var(--text3); margin-top: 4px; font-family: var(--mono); }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .section-title { font-family: var(--mono); font-size: 15px; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text3); }

  .job-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 12px; overflow: hidden; transition: border-color 0.15s; }
  .job-card:hover { border-color: var(--border2); }
  .job-card.active { border-left: 3px solid var(--accent); }
  .job-card.complete { border-left: 3px solid var(--green); }

  .job-header { display: flex; align-items: center; padding: 16px 20px; gap: 12px; }
  .job-header-main { display: flex; align-items: center; gap: 16px; flex: 1; cursor: pointer; min-width: 0; }
  .job-name { font-size: 20px; font-weight: 500; flex: 1; min-width: 0; }
  .job-status { font-family: var(--mono); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; padding: 3px 8px; border-radius: 2px; white-space: nowrap; }
  .status-active { background: rgba(245,166,35,0.15); color: var(--accent); }
  .status-complete { background: rgba(76,175,130,0.15); color: var(--green); }
  .job-quick-stats { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
  .job-stat { text-align: right; }
  .job-stat-label { font-size: 14px; color: var(--text3); font-family: var(--mono); }
  .job-stat-value { font-family: var(--mono); font-size: 18px; font-weight: 500; }
  .job-header-btns { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
  .job-chevron { color: var(--text3); transition: transform 0.2s; font-size: 22px; cursor: pointer; padding: 0 4px; flex-shrink: 0; }
  .job-card.expanded .job-chevron { transform: rotate(180deg); }

  .job-detail { display: none; border-top: 1px solid var(--border); padding: 20px; }
  .job-card.expanded .job-detail { display: block; }

  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  @media (max-width: 700px) { .detail-grid { grid-template-columns: 1fr; } }
  .detail-section { background: var(--bg3); border: 1px solid var(--border); border-radius: 3px; padding: 14px; }
  .detail-section-title { font-family: var(--mono); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }

  .line-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border); gap: 8px; }
  .line-item:last-child { border-bottom: none; }
  .line-item-label { color: var(--text2); font-size: 17px; flex: 1; }
  .line-item-value { font-family: var(--mono); font-size: 17px; white-space: nowrap; }
  .line-item-value.green { color: var(--green); }
  .line-item-value.red { color: var(--red); }
  .line-item-value.orange { color: var(--accent); }
  .line-item-value.dim { color: var(--text3); }

  .total-line { display: flex; justify-content: space-between; padding: 10px 0 0; margin-top: 6px; border-top: 1px solid var(--border2); font-weight: 600; }
  .total-line .line-item-value { font-size: 19px; }

  /* THREE-STATE STATUS BADGES */
  .status-badge { display: inline-flex; align-items: center; gap: 5px; font-family: var(--mono); font-size: 15px; padding: 3px 8px; border-radius: 2px; cursor: pointer; white-space: nowrap; user-select: none; transition: all 0.15s; }
  .badge-pending   { background: rgba(91,141,239,0.1);  color: var(--blue);   border: 1px solid rgba(91,141,239,0.3); }
  .badge-invoiced  { background: rgba(240,192,64,0.1);  color: var(--yellow); border: 1px solid rgba(240,192,64,0.3); }
  .badge-collected { background: rgba(76,175,130,0.1);  color: var(--green);  border: 1px solid rgba(76,175,130,0.3); }

  .settlement-box { background: var(--bg3); border: 1px solid var(--border2); border-radius: 3px; padding: 16px; margin-top: 16px; }
  .settlement-title { font-family: var(--mono); font-size: 15px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 14px; }
  .settlement-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 600px) { .settlement-grid { grid-template-columns: 1fr; } }
  .settlement-col-title { font-family: var(--mono); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 8px; }
  .settlement-big { font-family: var(--mono); font-size: 32px; font-weight: 600; margin-bottom: 4px; }
  .settlement-big.green { color: var(--green); }
  .settlement-big.orange { color: var(--accent); }
  .settlement-big.red { color: var(--red); }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.hidden { display: none; }
  .modal { background: var(--bg2); border: 1px solid var(--border2); border-radius: 6px; padding: 28px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; }
  .modal-wide { max-width: 660px; }
  .modal-title { font-family: var(--mono); font-size: 18px; font-weight: 600; color: var(--accent); margin-bottom: 24px; text-transform: uppercase; letter-spacing: 0.08em; }
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-family: var(--mono); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 6px; }
  .form-input { width: 100%; background: var(--bg3); border: 1px solid var(--border2); border-radius: 3px; padding: 10px 12px; color: var(--text); font-family: var(--mono); font-size: 17px; outline: none; transition: border-color 0.15s; }
  .form-input:focus { border-color: var(--accent); }
  .form-input::placeholder { color: var(--text3); }
  textarea.form-input { resize: vertical; min-height: 80px; font-family: var(--sans); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-hint { font-size: 15px; color: var(--text3); margin-top: 4px; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

  .milestone-list { margin-top: 8px; }
  .milestone-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
  .add-item-row { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }

  .tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
  .tab { font-family: var(--mono); font-size: 15px; text-transform: uppercase; letter-spacing: 0.08em; padding: 10px 18px; cursor: pointer; color: var(--text3); border-bottom: 2px solid transparent; transition: all 0.15s; margin-bottom: -1px; }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--text3); font-family: var(--mono); font-size: 17px; }
  .empty-state-icon { font-size: 44px; margin-bottom: 16px; }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  /* DEBT TRACKER */
  .debt-panel { background: var(--bg2); border: 1px solid var(--border2); border-left: 3px solid var(--red); border-radius: 4px; padding: 16px 20px; margin-bottom: 24px; }
  .debt-panel.paid { border-left-color: var(--green); }
  .debt-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .debt-panel-title { font-family: var(--mono); font-size: 15px; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text3); }
  .debt-panel-status { font-family: var(--mono); font-size: 15px; padding: 3px 8px; border-radius: 2px; background: rgba(224,92,92,0.12); color: var(--red); }
  .debt-panel-status.paid { background: rgba(76,175,130,0.12); color: var(--green); }
  .debt-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 14px; }
  .debt-stat-label { font-family: var(--mono); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 4px; }
  .debt-stat-value { font-family: var(--mono); font-size: 24px; font-weight: 600; }
  .debt-progress-track { background: var(--bg3); border-radius: 2px; height: 6px; overflow: hidden; }
  .debt-progress-fill { height: 100%; border-radius: 2px; background: var(--green); transition: width 0.4s; }
  .debt-progress-label { display: flex; justify-content: space-between; font-family: var(--mono); font-size: 14px; color: var(--text3); margin-top: 5px; }

  /* REPAYMENT TOGGLE */
  .repay-toggle { font-family: var(--mono); font-size: 15px; padding: 4px 10px; border-radius: 2px; border: 1px solid var(--border2); background: transparent; color: var(--text3); cursor: pointer; transition: all 0.15s; white-space: nowrap; }
  .repay-toggle.active { border-color: var(--red); color: var(--red); background: rgba(224,92,92,0.1); }
  .repay-toggle.paid { border-color: var(--text3); color: var(--text3); opacity: 0.4; cursor: default; }

  .divider { height: 1px; background: var(--border); margin: 16px 0; }
  .tag { display: inline-block; font-family: var(--mono); font-size: 14px; padding: 2px 6px; border-radius: 2px; margin-left: 6px; }
  .tag-mine { background: rgba(155,127,232,0.15); color: var(--purple); }
  .tag-his  { background: rgba(91,141,239,0.15);  color: var(--blue); }

  /* NOTES */
  .note-item { background: var(--bg3); border: 1px solid var(--border); border-radius: 3px; padding: 12px 14px; margin-bottom: 10px; }
  .note-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .note-date-label { font-family: var(--mono); font-size: 14px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; }
  .note-text { font-size: 17px; color: var(--text2); line-height: 1.55; white-space: pre-wrap; }
  .note-actions { display: flex; gap: 6px; }
  .add-form-divider { border-top: 1px solid var(--border2); padding-top: 18px; margin-top: 8px; }
  .add-form-label { font-family: var(--mono); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 14px; }

  /* HOURS */
  .hours-total-bar { background: var(--bg3); border: 1px solid var(--border2); border-radius: 3px; padding: 12px 16px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
  .hours-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); gap: 8px; }
  .hours-item:last-child { border-bottom: none; }

  /* â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    /* Header */
    .header { padding: 12px 16px; }
    .header-title { font-size: 17px; }
    .header-actions { gap: 6px; }
    .header-actions .btn-ghost.btn-sm { padding: 5px 8px; font-size: 11px; }
    .header-actions .btn-primary { padding: 7px 12px; font-size: 12px; }

    /* Main padding */
    .main { padding: 14px; }

    /* Summary cards â€” 2 columns on mobile */
    .summary-grid { grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 18px; }
    .summary-card { padding: 12px; }
    .summary-value { font-size: 20px; }

    /* Tabs */
    .tab { padding: 10px 12px; font-size: 11px; letter-spacing: 0.04em; }

    /* Job cards */
    .job-header { padding: 12px 14px; gap: 8px; flex-wrap: wrap; }
    .job-header-main { gap: 8px; flex-wrap: wrap; }
    .job-name { font-size: 17px; }
    .job-quick-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; width: 100%; margin-top: 6px; }
    .job-stat { text-align: left; }
    .job-header-btns { width: 100%; justify-content: flex-end; border-top: 1px solid var(--border); padding-top: 8px; margin-top: 2px; }
    .repay-toggle { font-size: 12px; padding: 5px 8px; }

    /* Debt panel */
    .debt-panel { padding: 14px; }
    .debt-stats { grid-template-columns: 1fr 1fr !important; gap: 12px; }
    .debt-stat-value { font-size: 18px; }

    /* Settlement box */
    .settlement-grid { grid-template-columns: 1fr; }
    .settlement-big { font-size: 26px; }

    /* Forms */
    .form-row { grid-template-columns: 1fr; }
    .modal { padding: 20px 16px; }
    .modal-title { font-size: 15px; margin-bottom: 18px; }

    /* Detail sections inside job */
    .detail-grid { grid-template-columns: 1fr; }
  }

  /* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .login-overlay { position:fixed;inset:0;background:var(--bg);z-index:998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;padding:24px; }
  .login-card { background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:32px;width:100%;max-width:380px; }
  .login-title { font-family:var(--mono);font-size:22px;font-weight:600;color:var(--accent);letter-spacing:0.08em;text-align:center;margin-bottom:6px; }
  .login-sub { font-family:var(--mono);font-size:12px;color:var(--text3);text-align:center;margin-bottom:28px;text-transform:uppercase;letter-spacing:0.1em; }
  .user-pick-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px; }
  .user-pick-btn { background:var(--bg3);border:2px solid var(--border);border-radius:4px;padding:14px 10px;font-family:var(--mono);font-size:13px;color:var(--text2);cursor:pointer;transition:all 0.15s;text-align:center;letter-spacing:0.04em; }
  .user-pick-btn:hover { border-color:var(--border2);color:var(--text); }
  .user-pick-btn.selected { border-color:var(--accent);color:var(--accent);background:rgba(245,166,35,0.08); }
  .login-pin-row { display:flex;gap:10px;margin-top:4px; }
  .login-error { font-family:var(--mono);font-size:12px;color:var(--red);text-align:center;margin-top:10px;min-height:18px; }

  /* â”€â”€ SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sched-toolbar { display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px; }
  .sched-view-toggle { display:flex;gap:0;border:1px solid var(--border2);border-radius:3px;overflow:hidden; }
  .sched-view-btn { font-family:var(--mono);font-size:12px;padding:7px 16px;cursor:pointer;background:transparent;color:var(--text3);border:none;transition:all 0.15s;text-transform:uppercase;letter-spacing:0.06em; }
  .sched-view-btn.active { background:var(--accent);color:#0f1117; }

  /* List view */
  .appt-card { background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--blue);border-radius:4px;padding:14px 16px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px; }
  .appt-card:hover { border-color:var(--border2); }
  .appt-card.past { border-left-color:var(--text3);opacity:0.6; }
  .appt-name { font-size:17px;font-weight:500;margin-bottom:4px; }
  .appt-meta { font-family:var(--mono);font-size:13px;color:var(--text2);display:flex;flex-wrap:wrap;gap:10px;margin-top:4px; }
  .appt-meta span { display:flex;align-items:center;gap:4px; }
  .appt-notes { font-size:13px;color:var(--text3);margin-top:6px;white-space:pre-wrap; }
  .appt-actions { display:flex;gap:6px;flex-shrink:0; }
  .no-appts { text-align:center;padding:48px 20px;color:var(--text3);font-family:var(--mono);font-size:14px; }

  /* Month calendar */
  .cal-nav { display:flex;align-items:center;justify-content:space-between;margin-bottom:16px; }
  .cal-month-label { font-family:var(--mono);font-size:18px;font-weight:600;color:var(--text); }
  .cal-grid { display:grid;grid-template-columns:repeat(7,1fr);gap:2px; }
  .cal-dow { font-family:var(--mono);font-size:11px;text-align:center;color:var(--text3);padding:6px 0;text-transform:uppercase;letter-spacing:0.08em; }
  .cal-cell { background:var(--bg2);border:1px solid var(--border);border-radius:3px;min-height:80px;padding:6px;cursor:pointer;transition:border-color 0.15s;position:relative; }
  .cal-cell:hover { border-color:var(--border2); }
  .cal-cell.other-month { opacity:0.35; }
  .cal-cell.today { border-color:var(--accent); }
  .cal-day-num { font-family:var(--mono);font-size:12px;color:var(--text3);margin-bottom:4px; }
  .cal-cell.today .cal-day-num { color:var(--accent);font-weight:600; }
  .cal-appt-pill { font-family:var(--mono);font-size:10px;background:rgba(91,141,239,0.2);color:var(--blue);border-radius:2px;padding:2px 5px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer; }
  .cal-appt-pill:hover { background:rgba(91,141,239,0.35); }
  .cal-more { font-family:var(--mono);font-size:10px;color:var(--text3);margin-top:2px; }

  /* Day detail drawer */
  .day-drawer { background:var(--bg2);border:1px solid var(--border2);border-radius:4px;padding:16px;margin-top:14px; }
  .day-drawer-title { font-family:var(--mono);font-size:12px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:12px; }

  /* User mgmt */
  .user-row { display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);gap:8px; }
  .user-row:last-child { border-bottom:none; }
  .user-row-name { font-family:var(--mono);font-size:14px; }
  .user-row-badge { font-family:var(--mono);font-size:11px;padding:2px 7px;border-radius:2px;background:rgba(245,166,35,0.12);color:var(--accent); }
  .user-row-badge.emp { background:rgba(91,141,239,0.12);color:var(--blue); }

  @media (max-width:600px) {
    .user-pick-grid { grid-template-columns:1fr; }
    .cal-cell { min-height:52px;padding:4px; }
    .cal-appt-pill { display:none; }
    .cal-cell.has-appts::after { content:'â€¢';color:var(--blue);font-size:16px;display:block;text-align:center; }
    .cal-dow { font-size:10px;padding:4px 0; }
    .sched-toolbar { flex-direction:column;align-items:flex-start; }
  }
</style>
</head>
<body>


<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-card">
    <div class="login-title">EHS TRACKER</div>
    <div class="login-sub">Select your name and enter PIN</div>
    <div id="userPickGrid" class="user-pick-grid"></div>
    <div class="form-group" style="margin-bottom:0">
      <label class="form-label">PIN</label>
      <div class="login-pin-row">
        <input class="form-input" id="loginPin" type="password" inputmode="numeric" maxlength="10" placeholder="Enter PIN" onkeydown="if(event.key==='Enter')doLogin()" style="flex:1" />
        <button class="btn btn-primary" onclick="doLogin()">Enter</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:14px;justify-content:center">
      <input type="checkbox" id="keepLoggedIn" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer" />
      <label for="keepLoggedIn" style="font-family:var(--mono);font-size:12px;color:var(--text3);cursor:pointer;user-select:none">Keep me logged in</label>
    </div>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<div id="loadingOverlay" style="position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px">
  <div style="font-family:var(--mono);font-size:20px;color:var(--accent);letter-spacing:0.1em">JOB/TRACKER</div>
  <div style="font-family:var(--mono);font-size:13px;color:var(--text3)">Connecting to database...</div>
</div>

<div class="header">
  <div class="header-title">JOB<span>/</span>TRACKER</div>
  <div class="header-actions">
    <span id="headerUserLabel" style="font-family:var(--mono);font-size:12px;color:var(--text3);display:none"></span>
    <button class="btn btn-ghost btn-sm" id="signOutBtn" onclick="signOut()" style="display:none">âŽ‹ Sign Out</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)" />
    <button class="btn btn-ghost btn-sm admin-only" onclick="openSettings()">âš™ Settings</button>
    <button class="btn btn-primary admin-only" onclick="openNewJobModal()">+ New Job</button>
  </div>
</div>

<div class="main">
  <div id="debtPanel"></div>
  <div id="summaryCards" class="summary-grid"></div>
  <div class="tabs">
    <div class="tab job-tab active" onclick="switchTab('active', this)">Active Jobs</div>
    <div class="tab job-tab" onclick="switchTab('complete', this)">Completed</div>
    <div class="tab job-tab" onclick="switchTab('all', this)">All Jobs</div>
    <div class="tab" id="schedTab" onclick="switchTab('schedule', this)">Schedule</div>
  </div>
  <div id="tab-active" class="tab-content active">
    <div class="section-header"><span class="section-title" id="activeCount"></span></div>
    <div id="activeJobsList"></div>
  </div>
  <div id="tab-complete" class="tab-content"><div id="completeJobsList"></div></div>
  <div id="tab-all" class="tab-content"><div id="allJobsList"></div></div>
  <div id="tab-schedule" class="tab-content"><div id="scheduleContent"></div></div>
</div>

<!-- NEW/EDIT JOB MODAL -->
<div id="jobModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title" id="jobModalTitle">New Job</div>
    <div class="form-group">
      <label class="form-label">Client Name</label>
      <input class="form-input" id="f_name" placeholder="e.g. Griffin, Mendoza..." />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Quote Amount ($)</label>
        <input class="form-input" id="f_quote" type="number" step="0.01" placeholder="0.00" oninput="updateMilestonePreview()" />
      </div>
      <div class="form-group">
        <label class="form-label">Start Date</label>
        <input class="form-input" id="f_date" type="date" />
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Payment Structure â€” Milestones</label>
      <div class="form-hint" style="margin-bottom:8px;">Define % collected at each stage. Must add up to 100%.</div>
      <div id="milestoneList" class="milestone-list"></div>
      <button class="btn btn-ghost btn-sm" style="margin-top:8px;" onclick="addMilestoneField()">+ Add Milestone</button>
      <div id="milestoneError" style="color:var(--red);font-size:15px;margin-top:4px;"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('jobModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveJob()">Save Job</button>
    </div>
  </div>
</div>

<!-- ADD ITEM MODAL -->
<div id="addItemModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title" id="addItemTitle">Add Item</div>
    <div id="addItemForm"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addItemModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()">Save</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">Settings</div>
    <div class="form-group">
      <label class="form-label">Employee Name</label>
      <input class="form-input" id="s_empName" placeholder="e.g. Dad, Tyler..." />
    </div>
    <div class="form-group">
      <label class="form-label">Employee profit share (e.g. 0.66 for 66%)</label>
      <input class="form-input" id="s_empShare" type="number" step="0.01" min="0" max="1" />
    </div>
    <div class="form-group">
      <label class="form-label">Square processing fee rate (e.g. 0.026 for 2.6%)</label>
      <input class="form-input" id="s_feeRate" type="number" step="0.001" min="0" max="1" />
      <div class="form-hint">Applied to collected amounts. Fees deducted before split.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Original debt owed by employee ($)</label>
      <input class="form-input" id="s_debtOriginal" type="number" step="0.01" min="0" />
      <div class="form-hint">Total processing fee overpayment agreed upon. Default: $2,256.58</div>
    </div>
    <div class="form-group">
      <label class="form-label">Repayment split â€” your share (e.g. 0.50 for 50%)</label>
      <input class="form-input" id="s_debtOwnerShare" type="number" step="0.01" min="0" max="1" />
      <div class="form-hint">Normal is ${(1 - (state?.settings?.empShare||0.66)).toFixed(2)}. Extra above normal counts toward debt.</div>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:4px;display:flex;flex-wrap:wrap;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="exportData()">â¬‡ Export Backup</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('settingsModal');document.getElementById('importFile').click()">â¬† Import Backup</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('settingsModal');openChangePin()">ðŸ”‘ Change My PIN</button>
    </div>
    <div class="modal-actions" style="position:relative">
      <span style="position:absolute;left:0;bottom:0;font-family:var(--mono);font-size:12px;color:var(--text3)">v1.14</span>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('settingsModal');openUserMgmt()" style="margin-right:auto;margin-left:40px">ðŸ‘¥ Users</button>
      <button class="btn btn-ghost" onclick="closeModal('settingsModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<!-- NOTES MODAL -->
<div id="notesModal" class="modal-overlay hidden">
  <div class="modal modal-wide">
    <div class="modal-title" id="notesModalTitle">Notes</div>
    <div id="notesList"></div>
    <div class="add-form-divider">
      <div class="add-form-label">Add Note</div>
      <div class="form-row" style="margin-bottom:12px;">
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Date</label>
          <input class="form-input" id="n_date" type="date" />
        </div>
        <div></div>
      </div>
      <div class="form-group">
        <label class="form-label">Note</label>
        <textarea class="form-input" id="n_text" placeholder="Add a note..."></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn btn-primary btn-sm" onclick="saveNote()">Save Note</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('notesModal')">Close</button>
    </div>
  </div>
</div>

<!-- EDIT NOTE MODAL -->
<div id="editNoteModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">Edit Note</div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input class="form-input" id="en_date" type="date" />
    </div>
    <div class="form-group">
      <label class="form-label">Note</label>
      <textarea class="form-input" id="en_text"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('editNoteModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditNote()">Save</button>
    </div>
  </div>
</div>

<!-- HOURS MODAL -->
<div id="hoursModal" class="modal-overlay hidden">
  <div class="modal modal-wide">
    <div class="modal-title" id="hoursModalTitle">Hours</div>
    <div id="hoursTotalBar"></div>
    <div id="hoursList"></div>
    <div class="add-form-divider">
      <div class="add-form-label">Log Hours</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date</label>
          <input class="form-input" id="h_date" type="date" />
        </div>
        <div class="form-group">
          <label class="form-label">Hours</label>
          <input class="form-input" id="h_hours" type="number" step="0.5" placeholder="0" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Note (optional)</label>
        <input class="form-input" id="h_note" placeholder="e.g. Framing, demo, rough-in..." />
      </div>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn btn-primary btn-sm" onclick="saveHours()">Log Hours</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('hoursModal')">Close</button>
    </div>
  </div>
</div>

<!-- DEBT PAYMENT MODAL -->
<div id="debtPaymentModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">Add Manual Payment</div>
    <div class="form-group">
      <label class="form-label">Description (optional)</label>
      <input class="form-input" id="dp_label" placeholder="e.g. Cash payment, Venmo..." />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Amount ($)</label>
        <input class="form-input" id="dp_amount" type="number" step="0.01" placeholder="0.00" />
      </div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" id="dp_date" type="date" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('debtPaymentModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDebtPayment()">Save Payment</button>
    </div>
  </div>
</div>


<!-- APPOINTMENT MODAL -->
<div id="apptModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title" id="apptModalTitle">New Appointment</div>
    <div class="form-group">
      <label class="form-label">Client / Job Name</label>
      <input class="form-input" id="ap_name" placeholder="e.g. Smith residence" />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" id="ap_date" type="date" />
      </div>
      <div class="form-group">
        <label class="form-label">Time</label>
        <input class="form-input" id="ap_time" type="time" />
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Address (optional)</label>
      <input class="form-input" id="ap_address" placeholder="e.g. 123 Main St" />
    </div>
    <div class="form-group">
      <label class="form-label">Notes (optional)</label>
      <textarea class="form-input" id="ap_notes" placeholder="Anything they need to know..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('apptModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAppt()">Save</button>
    </div>
  </div>
</div>

<!-- USER MANAGEMENT MODAL -->
<div id="userMgmtModal" class="modal-overlay hidden">
  <div class="modal modal-wide">
    <div class="modal-title">User Management</div>
    <div id="userList" style="margin-bottom:20px"></div>
    <div style="border-top:1px solid var(--border2);padding-top:18px">
      <div class="add-form-label">Add User</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input class="form-input" id="nu_name" placeholder="e.g. Jake" />
        </div>
        <div class="form-group">
          <label class="form-label">PIN</label>
          <input class="form-input" id="nu_pin" type="password" inputmode="numeric" maxlength="10" placeholder="Choose a PIN" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-input" id="nu_role">
          <option value="employee">Employee (schedule only)</option>
          <option value="admin">Admin (full access)</option>
        </select>
      </div>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn btn-primary btn-sm" onclick="addUser()">Add User</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('userMgmtModal')">Close</button>
    </div>
  </div>
</div>

<!-- RESET PIN MODAL -->
<div id="resetPinModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">Reset PIN</div>
    <div class="form-group">
      <label class="form-label" id="resetPinLabel">New PIN for user</label>
      <input class="form-input" id="rp_pin" type="password" inputmode="numeric" maxlength="10" placeholder="New PIN" />
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('resetPinModal')">Cancel</button>
      <button class="btn btn-primary" onclick="doResetPin()">Save PIN</button>
    </div>
  </div>
</div>

<!-- CHANGE OWN PIN MODAL -->
<div id="changePinModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">Change My PIN</div>
    <div class="form-group">
      <label class="form-label">Current PIN</label>
      <input class="form-input" id="cp_old" type="password" inputmode="numeric" maxlength="10" />
    </div>
    <div class="form-group">
      <label class="form-label">New PIN</label>
      <input class="form-input" id="cp_new" type="password" inputmode="numeric" maxlength="10" />
    </div>
    <div class="form-group">
      <label class="form-label">Confirm New PIN</label>
      <input class="form-input" id="cp_confirm" type="password" inputmode="numeric" maxlength="10" />
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('changePinModal')">Cancel</button>
      <button class="btn btn-primary" onclick="doChangePin()">Update PIN</button>
    </div>
  </div>
</div>
<script>
// â”€â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyCZyxBVvINYbPeWSDkNPZsxnw9f_6uGEV4",
  authDomain: "ehs-tracker-7d6ed.firebaseapp.com",
  projectId: "ehs-tracker-7d6ed",
  storageBucket: "ehs-tracker-7d6ed.firebasestorage.app",
  messagingSenderId: "1043751819433",
  appId: "1:1043751819433:web:1cdd11e6fd9efb4d0871b8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const DOC = db.collection('jobtracker').doc('state');

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  settings: { empName: 'Employee', empShare: 0.66, feeRate: 0.026, debtOriginal: 2256.58, debtOwnerShare: 0.50 },
  debtPayments: [],
  jobs: [],
  users: [],
  appointments: []
};
let editingJobId = null;
let addItemContext = null;
let notesJobId = null;
let hoursJobId = null;
let editNoteCtx = null;
let isSaving = false;
let currentUser = null; // { id, name, isAdmin }
let editingApptId = null;
let resetPinUserId = null;
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth(); // 0-indexed
let schedView = 'list'; // 'list' | 'month'
let selectedCalDay = null;
let selectedDayFilter = null; // mobile day-drill-down

// â”€â”€â”€ PERSIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function migrateState(s) {
  if (!s.settings.empName) s.settings.empName = 'Employee';
  if (s.settings.historicalAdj !== undefined && s.settings.debtOriginal === undefined) {
    s.settings.debtOriginal = s.settings.historicalAdj;
    delete s.settings.historicalAdj;
  }
  if (s.settings.debtOriginal === undefined) s.settings.debtOriginal = 2256.58;
  if (s.settings.debtOwnerShare === undefined) s.settings.debtOwnerShare = 0.50;
  if (!s.debtPayments) s.debtPayments = [];
  if (!s.users) s.users = [];
  if (!s.appointments) s.appointments = [];
  // Ensure there's always at least one admin user seeded
  if (s.users.length === 0) {
    s.users.push({ id: 'admin_default', name: 'Ty', pin: '1234', isAdmin: true });
  }
  (s.jobs || []).forEach(job => {
    if (job.repaymentMode === undefined) job.repaymentMode = false;
    if (!job.jobNotes) {
      job.jobNotes = [];
      if (job.notes && typeof job.notes === 'string' && job.notes.trim()) {
        job.jobNotes.push({ id: uid(), text: job.notes, date: job.date || today() });
      }
    }
    delete job.notes;
    if (!job.hours) job.hours = [];
    (job.milestones || []).forEach(m => {
      if (m.status === undefined) { m.status = m.collected ? 'collected' : 'pending'; delete m.collected; }
    });
    (job.addOns || []).forEach(a => {
      if (a.status === undefined) { a.status = a.collected ? 'collected' : 'pending'; delete a.collected; }
      if (a.date === undefined) a.date = '';
    });
  });
  return s;
}

async function save() {
  if (isSaving) return;
  isSaving = true;
  try {
    await DOC.set(JSON.parse(JSON.stringify(state)));
  } catch(e) {
    console.error('Save failed:', e);
    alert('Save failed â€” check your connection.');
  } finally {
    isSaving = false;
  }
}

function load() {
  // Check for old localStorage data to migrate on first run
  const legacy = localStorage.getItem('jobtracker_v2');

  DOC.get().then(doc => {
    if (doc.exists) {
      state = migrateState(doc.data());
    } else if (legacy) {
      // First time using Firebase â€” migrate local data up
      try {
        state = migrateState(JSON.parse(legacy));
        save(); // push to Firestore
        localStorage.removeItem('jobtracker_v2');
      } catch(e) {}
    }
    document.getElementById('loadingOverlay').style.display = 'none';
    showLogin();
  }).catch(e => {
    console.error('Load failed:', e);
    document.getElementById('loadingOverlay').innerHTML = `
      <div style="font-family:var(--mono);font-size:16px;color:var(--red)">Connection failed</div>
      <div style="font-family:var(--mono);font-size:13px;color:var(--text3);margin-top:8px">${e.message}</div>`;
  });

  // Real-time listener â€” keeps all open tabs/devices in sync
  DOC.onSnapshot(doc => {
    if (doc.exists && !isSaving) {
      state = migrateState(doc.data());
      if (currentUser) {
        // Refresh currentUser data in case PIN/name changed
        const fresh = state.users.find(u => u.id === currentUser.id);
        if (fresh) currentUser = { id: fresh.id, name: fresh.name, isAdmin: fresh.isAdmin };
        renderAll();
      }
    }
  });
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function today() { return new Date().toISOString().slice(0,10); }
function fmt(n) {
  if (n === null || n === undefined || isNaN(n)) return '$0.00';
  const s = Math.abs(n).toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 });
  return (n < 0 ? '-$' : '$') + s;
}
function fmtDate(d) {
  if (!d) return '';
  const p = d.split('-');
  return p.length === 3 ? `${p[1]}/${p[2]}/${p[0]}` : d;
}
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â”€â”€â”€ CALCULATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcJob(job) {
  const { empShare, feeRate, debtOwnerShare } = state.settings;
  const normalOwnerShare = 1 - empShare;
  const effectiveOwnerShare = job.repaymentMode ? (debtOwnerShare || 0.50) : normalOwnerShare;
  const effectiveEmpShare   = 1 - effectiveOwnerShare;
  const ownerShare = effectiveOwnerShare;

  const addOnTotal = (job.addOns || []).reduce((s,a) => s + (a.amount||0), 0);
  const contractTotal = (job.quote || 0) + addOnTotal;

  let collectedGross = 0, estimatedFees = 0;
  (job.milestones || []).forEach(m => {
    if (m.status === 'collected') {
      const g = (m.pct/100) * (job.quote||0);
      collectedGross += g; estimatedFees += g * feeRate;
    }
  });
  (job.addOns || []).forEach(a => {
    if (a.status === 'collected') {
      collectedGross += a.amount||0; estimatedFees += (a.amount||0) * feeRate;
    }
  });
  const manualFees = (job.fees || []).reduce((s,f) => s + (f.amount||0), 0);
  const totalFees = estimatedFees + manualFees;
  const netRevenue = collectedGross - totalFees;

  let pendingGross = 0;
  (job.milestones || []).forEach(m => { if (m.status !== 'collected') pendingGross += (m.pct/100)*(job.quote||0); });
  (job.addOns || []).forEach(a => { if (a.status !== 'collected') pendingGross += a.amount||0; });

  const ownerMats = (job.materials||[]).filter(m=>m.who==='owner').reduce((s,m)=>s+(m.amount||0),0);
  const empMats   = (job.materials||[]).filter(m=>m.who==='emp').reduce((s,m)=>s+(m.amount||0),0);
  const totalMats = ownerMats + empMats;

  const profitPool  = netRevenue - totalMats;
  const empProfit   = profitPool * effectiveEmpShare;
  const ownerProfit = profitPool * effectiveOwnerShare;
  const debtContribution = job.repaymentMode ? Math.max(0, profitPool * ((debtOwnerShare||0.50) - normalOwnerShare)) : 0;
  const empTotalOwed = empProfit + empMats;
  const advancesPaid = (job.advances||[]).reduce((s,a)=>s+(a.amount||0),0);
  const empBalance   = empTotalOwed - advancesPaid;
  const ownerTotal   = ownerProfit + ownerMats;
  const totalHours   = (job.hours||[]).reduce((s,h)=>s+(h.hours||0),0);

  return { contractTotal, addOnTotal, collectedGross, pendingGross,
    totalFees, netRevenue, totalMats, ownerMats, empMats,
    profitPool, empProfit, ownerProfit, debtContribution,
    empTotalOwed, advancesPaid, empBalance, ownerTotal, totalHours };
}

// â”€â”€â”€ DEBT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDebtPanel() {
  const s = state.settings;
  const originalDebt = s.debtOriginal || 0;
  if (!originalDebt) { document.getElementById('debtPanel').innerHTML = ''; return; }

  let jobRepaid = 0;
  state.jobs.forEach(j => { jobRepaid += calcJob(j).debtContribution; });
  const manualRepaid = (state.debtPayments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
  const totalRepaid = jobRepaid + manualRepaid;
  const remaining = Math.max(0, originalDebt - totalRepaid);
  const pct = Math.min(100, (totalRepaid / originalDebt) * 100);
  const paid = remaining <= 0;
  const en = esc(s.empName || 'Employee');
  const normalPct = Math.round((1 - s.empShare) * 100);
  const repayPct  = Math.round((s.debtOwnerShare || 0.50) * 100);

  const paymentsHtml = (state.debtPayments || []).length
    ? [...state.debtPayments].reverse().map(p => `
        <div class="line-item" style="padding:6px 0">
          <div class="line-item-label" style="font-size:15px">${esc(p.label||'Manual payment')}<span style="font-size:11px;color:var(--text3);margin-left:8px;font-family:var(--mono)">${fmtDate(p.date)||''}</span></div>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="line-item-value green">+${fmt(p.amount)}</div>
            <button class="btn btn-danger btn-sm" onclick="deleteDebtPayment('${p.id}')">âœ•</button>
          </div>
        </div>`).join('')
    : '';

  document.getElementById('debtPanel').innerHTML = `
    <div class="debt-panel${paid?' paid':''}">
      <div class="debt-panel-header">
        <span class="debt-panel-title">âš– Fee Debt Repayment â€” ${en}</span>
        <span class="debt-panel-status${paid?' paid':''}">${paid ? 'âœ“ PAID OFF' : `${repayPct}/${100-repayPct} split active`}</span>
      </div>
      <div class="debt-stats" style="grid-template-columns:repeat(4,1fr)">
        <div>
          <div class="debt-stat-label">Original Debt</div>
          <div class="debt-stat-value" style="color:var(--text2)">${fmt(originalDebt)}</div>
        </div>
        <div>
          <div class="debt-stat-label">Via Job Splits</div>
          <div class="debt-stat-value" style="color:var(--green)">${fmt(jobRepaid)}</div>
        </div>
        <div>
          <div class="debt-stat-label">Manual Payments</div>
          <div class="debt-stat-value" style="color:var(--green)">${fmt(manualRepaid)}</div>
        </div>
        <div>
          <div class="debt-stat-label">Remaining</div>
          <div class="debt-stat-value" style="color:${paid?'var(--green)':'var(--red)'}">${fmt(remaining)}</div>
        </div>
      </div>
      <div class="debt-progress-track">
        <div class="debt-progress-fill" style="width:${pct.toFixed(1)}%"></div>
      </div>
      <div class="debt-progress-label" style="margin-bottom:${paymentsHtml||!paid?'12px':'0'}">
        <span>${pct.toFixed(1)}% repaid</span>
        <span>Normal split ${normalPct}/${100-normalPct} Â· Repayment split ${repayPct}/${100-repayPct}</span>
      </div>
      ${paymentsHtml ? `<div style="border-top:1px solid var(--border);padding-top:10px;margin-bottom:10px">${paymentsHtml}</div>` : ''}
      <button class="btn btn-ghost btn-sm" onclick="openAddDebtPayment()">+ Manual Payment</button>
    </div>`;
}

// â”€â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary() {
  renderDebtPanel();
  const active = state.jobs.filter(j => j.status !== 'complete');
  let tContract=0, tCollected=0, tPending=0, tEmpBal=0, tOwner=0;
  active.forEach(j => {
    const c = calcJob(j);
    tContract += c.contractTotal; tCollected += c.collectedGross;
    tPending  += c.pendingGross;  tEmpBal    += c.empBalance;
    tOwner    += c.ownerTotal;
  });
  const en = esc(state.settings.empName || 'Employee');
  document.getElementById('summaryCards').innerHTML = `
    <div class="summary-card"><div class="summary-label">Active Jobs</div><div class="summary-value">${active.length}</div></div>
    <div class="summary-card"><div class="summary-label">Total Contract Value</div><div class="summary-value orange">${fmt(tContract)}</div></div>
    <div class="summary-card"><div class="summary-label">Collected</div><div class="summary-value green">${fmt(tCollected)}</div><div class="summary-sub">${fmt(tPending)} pending</div></div>
    <div class="summary-card"><div class="summary-label">Your Profit (active)</div><div class="summary-value green">${fmt(tOwner)}</div><div class="summary-sub">from collected revenue</div></div>
    <div class="summary-card"><div class="summary-label">Owed to ${en}</div><div class="summary-value ${tEmpBal < 0 ? 'red' : 'orange'}">${fmt(Math.max(0, tEmpBal))}</div><div class="summary-sub">across active jobs</div></div>`;
}

// â”€â”€â”€ RENDER JOBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderJobs() {
  renderSummary();
  const active   = state.jobs.filter(j => j.status !== 'complete');
  const complete = state.jobs.filter(j => j.status === 'complete');
  document.getElementById('activeCount').textContent = `${active.length} active job${active.length!==1?'s':''}`;
  document.getElementById('activeJobsList').innerHTML   = active.length   ? active.map(jobCard).join('')   : emptyState('No active jobs. Click + New Job to get started.');
  document.getElementById('completeJobsList').innerHTML = complete.length ? complete.map(jobCard).join('') : emptyState('No completed jobs yet.');
  document.getElementById('allJobsList').innerHTML      = state.jobs.length ? state.jobs.map(jobCard).join('') : emptyState('No jobs yet.');
}
function emptyState(msg) { return `<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div>${msg}</div>`; }

function jobCard(job) {
  const c = calcJob(job);
  const isExp = job._expanded;
  const sc    = job.status === 'complete' ? 'complete' : 'active';
  const sl    = job.status === 'complete' ? 'Complete' : 'Active';
  const sb    = job.status === 'complete' ? 'status-complete' : 'status-active';
  const nc    = (job.jobNotes||[]).length;
  const th    = c.totalHours;
  return `
  <div class="job-card ${sc} ${isExp?'expanded':''}" id="job_${job.id}">
    <div class="job-header">
      <div class="job-header-main" onclick="toggleJob('${job.id}')">
        <div>
          <div class="job-name">${esc(job.name)}</div>
          <div style="font-size:15px;color:var(--text3);margin-top:2px;font-family:var(--mono)">${job.date||''}</div>
        </div>
        <span class="job-status ${sb}">${sl}</span>
        <div class="job-quick-stats">
          <div class="job-stat"><div class="job-stat-label">Quote</div><div class="job-stat-value">${fmt(job.quote)}</div></div>
          <div class="job-stat"><div class="job-stat-label">Add-ons</div><div class="job-stat-value" style="color:var(--purple)">${fmt(c.addOnTotal)}</div></div>
          <div class="job-stat"><div class="job-stat-label">Contract Total</div><div class="job-stat-value">${fmt(c.contractTotal)}</div></div>
          <div class="job-stat"><div class="job-stat-label">Collected</div><div class="job-stat-value" style="color:var(--green)">${fmt(c.collectedGross)}</div></div>
          <div class="job-stat"><div class="job-stat-label">Emp. Balance</div><div class="job-stat-value" style="color:var(--accent)">${fmt(c.empBalance)}</div></div>
        </div>
      </div>
      <div class="job-header-btns">
        <button class="btn btn-ghost btn-sm" onclick="openNotes('${job.id}')" title="Notes">ðŸ“${nc>0?` ${nc}`:''}</button>
        <button class="btn btn-ghost btn-sm" onclick="openHours('${job.id}')" title="Hours">â±${th>0?` ${th}h`:''}</button>
        <button class="repay-toggle${job.repaymentMode?' active':''}" onclick="toggleRepayment('${job.id}')" title="Toggle debt repayment split for this job">${job.repaymentMode?'âš– Repaying':'âš– Normal'}</button>
        <div class="job-chevron" onclick="toggleJob('${job.id}')">â–¾</div>
      </div>
    </div>
    ${isExp ? jobDetail(job, c) : ''}
  </div>`;
}

function badgeHtml(status, jobId, itemType, idx) {
  const cfg = {
    pending:   { cls:'badge-pending',   label:'â—‹ Pending'  },
    invoiced:  { cls:'badge-invoiced',  label:'â—‘ Invoiced' },
    collected: { cls:'badge-collected', label:'âœ“ Collected'}
  };
  const { cls, label } = cfg[status] || cfg.pending;
  return `<span class="status-badge ${cls}" onclick="cycleStatus('${jobId}','${itemType}',${idx})" title="Click to cycle">${label}</span>`;
}

function jobDetail(job, c) {
  const en = esc(state.settings.empName || 'Employee');

  const milestonesHtml = (job.milestones||[]).map((m,i) => {
    const amt = (m.pct/100)*(job.quote||0);
    const st  = m.status||'pending';
    return `<div class="line-item">
      <div class="line-item-label">${esc(m.label||`Milestone ${i+1}`)} (${m.pct}%)</div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="line-item-value ${st==='collected'?'green':'dim'}">${fmt(amt)}</div>
        ${badgeHtml(st,job.id,'milestones',i)}
      </div>
    </div>`;
  }).join('');

  const addOnsHtml = (job.addOns||[]).map((a,i) => {
    const st = a.status||'pending';
    return `<div class="line-item">
      <div class="line-item-label">${esc(a.label||'Add-on')}${a.date?`<span style="font-size:14px;color:var(--text3);margin-left:6px">${fmtDate(a.date)}</span>`:''}</div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="line-item-value ${st==='collected'?'green':'dim'}">${fmt(a.amount)}</div>
        ${badgeHtml(st,job.id,'addOns',i)}
        <button class="btn btn-danger btn-sm" onclick="removeItem('${job.id}','addOns',${i})">âœ•</button>
      </div>
    </div>`;
  }).join('');

  const matsHtml = (job.materials||[]).map((m,i) => `
    <div class="line-item">
      <div class="line-item-label">${esc(m.label||'Materials')}<span class="tag ${m.who==='owner'?'tag-mine':'tag-his'}">${m.who==='owner'?'mine':en}</span></div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="line-item-value red">${fmt(m.amount)}</div>
        <button class="btn btn-danger btn-sm" onclick="removeItem('${job.id}','materials',${i})">âœ•</button>
      </div>
    </div>`).join('');

  const advHtml = (job.advances||[]).map((a,i) => `
    <div class="line-item">
      <div class="line-item-label">${esc(a.label||'Advance')} <span style="font-size:15px;color:var(--text3)">${a.date||''}</span></div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="line-item-value red">${fmt(a.amount)}</div>
        <button class="btn btn-danger btn-sm" onclick="removeItem('${job.id}','advances',${i})">âœ•</button>
      </div>
    </div>`).join('');

  return `
  <div class="job-detail">
    <div class="detail-grid">
      <div class="detail-section">
        <div class="detail-section-title">Revenue & Collections</div>
        <div class="line-item"><div class="line-item-label">Base Quote</div><div class="line-item-value">${fmt(job.quote)}</div></div>
        ${milestonesHtml}
        <div class="divider"></div>
        <div style="font-size:15px;color:var(--text3);margin-bottom:6px;font-family:var(--mono);text-transform:uppercase;letter-spacing:0.08em">Add-ons</div>
        ${addOnsHtml||'<div style="color:var(--text3);font-size:16px;padding:4px 0">None</div>'}
        <div class="add-item-row"><button class="btn btn-ghost btn-sm" onclick="openAddItem('${job.id}','addon')">+ Add-on</button></div>
        <div class="total-line"><span style="color:var(--text2)">Collected (gross)</span><span class="line-item-value green">${fmt(c.collectedGross)}</span></div>
        <div class="line-item" style="padding-top:6px">
          <div class="line-item-label" style="font-size:16px">Est. Square fees (~${(state.settings.feeRate*100).toFixed(1)}%)</div>
          <div class="line-item-value red" style="font-size:16px">-${fmt(c.totalFees)}</div>
        </div>
        <div class="total-line"><span style="color:var(--text2)">Net Revenue</span><span class="line-item-value orange">${fmt(c.netRevenue)}</span></div>
      </div>

      <div class="detail-section">
        <div class="detail-section-title">Materials</div>
        ${matsHtml||'<div style="color:var(--text3);font-size:16px;padding:4px 0">None logged</div>'}
        <div class="add-item-row"><button class="btn btn-ghost btn-sm" onclick="openAddItem('${job.id}','material')">+ Material</button></div>
        <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
          <div class="line-item"><div class="line-item-label" style="font-size:16px">My materials</div><div class="line-item-value dim" style="font-size:16px">-${fmt(c.ownerMats)}</div></div>
          <div class="line-item"><div class="line-item-label" style="font-size:16px">${en}'s materials</div><div class="line-item-value dim" style="font-size:16px">-${fmt(c.empMats)}</div></div>
        </div>
        <div class="total-line"><span style="color:var(--text2)">Total Materials</span><span class="line-item-value red">-${fmt(c.totalMats)}</span></div>
        <div class="divider"></div>
        <div class="detail-section-title" style="margin-top:4px">Employee Advances</div>
        ${advHtml||'<div style="color:var(--text3);font-size:16px;padding:4px 0">None logged</div>'}
        <div class="add-item-row"><button class="btn btn-ghost btn-sm" onclick="openAddItem('${job.id}','advance')">+ Advance</button></div>
        <div class="total-line"><span style="color:var(--text2)">Total Advances</span><span class="line-item-value red">-${fmt(c.advancesPaid)}</span></div>
      </div>
    </div>

    <div class="settlement-box">
      <div class="settlement-title">Settlement Breakdown${job.repaymentMode?` <span style="color:var(--red);font-size:14px;margin-left:8px">âš– REPAYMENT SPLIT ${Math.round((state.settings.debtOwnerShare||0.5)*100)}/${Math.round((1-(state.settings.debtOwnerShare||0.5))*100)}</span>`:''}</div>
      <div class="settlement-grid">
        <div>
          <div class="settlement-col-title">Your ${Math.round((job.repaymentMode?(state.settings.debtOwnerShare||0.5):(1-state.settings.empShare))*100)}%</div>
          <div class="settlement-big orange">${fmt(c.ownerProfit)}</div>
          <div style="font-size:16px;color:var(--text3);font-family:var(--mono)">profit share</div>
          ${job.repaymentMode&&c.debtContribution>0?`<div style="font-size:16px;color:var(--red);font-family:var(--mono);margin-top:4px">âš– ${fmt(c.debtContribution)} â†’ debt</div>`:''}
          <div style="font-size:16px;color:var(--text2);font-family:var(--mono);margin-top:4px">+ ${fmt(c.ownerMats)} mats back</div>
          <div style="font-size:17px;color:var(--green);font-family:var(--mono);font-weight:600;margin-top:6px;border-top:1px solid var(--border);padding-top:6px">= ${fmt(c.ownerTotal)} total</div>
        </div>
        <div>
          <div class="settlement-col-title">${en} (${Math.round((job.repaymentMode?(1-(state.settings.debtOwnerShare||0.5)):state.settings.empShare)*100)}%)</div>
          <div class="settlement-big ${c.empBalance>0?'orange':'green'}">${fmt(Math.abs(c.empBalance))}</div>
          <div style="font-size:16px;color:var(--text3);font-family:var(--mono)">${c.empBalance>0?'still owed':'he owes you'}</div>
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
            <div style="font-size:16px;color:var(--text2);font-family:var(--mono)">Profit share: ${fmt(c.empProfit)}</div>
            <div style="font-size:16px;color:var(--text2);font-family:var(--mono)">+ Mats back: ${fmt(c.empMats)}</div>
            <div style="font-size:16px;color:var(--text2);font-family:var(--mono);border-top:1px solid var(--border);padding-top:4px;margin-top:4px">= Total owed: ${fmt(c.empTotalOwed)}</div>
            <div style="font-size:16px;color:var(--text2);font-family:var(--mono)">âˆ’ Advances paid: ${fmt(c.advancesPaid)}</div>
          </div>
          <div style="font-size:15px;color:var(--text3);font-family:var(--mono);margin-top:6px">Profit pool: ${fmt(c.profitPool)}</div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="editJob('${job.id}')">âœ Edit Job</button>
      <button class="btn btn-${job.status==='complete'?'ghost':'green'} btn-sm" onclick="toggleComplete('${job.id}')">
        ${job.status==='complete'?'â†© Reopen':'âœ“ Mark Complete'}
      </button>
      <button class="btn btn-danger btn-sm" onclick="deleteJob('${job.id}')">ðŸ—‘ Delete</button>
    </div>
  </div>`;
}

// â”€â”€â”€ INTERACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ DEBT PAYMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddDebtPayment() {
  document.getElementById('dp_label').value  = '';
  document.getElementById('dp_amount').value = '';
  document.getElementById('dp_date').value   = today();
  document.getElementById('debtPaymentModal').classList.remove('hidden');
}
function saveDebtPayment() {
  const amount = parseFloat(document.getElementById('dp_amount').value);
  if (!amount || amount <= 0) { alert('Please enter a valid amount.'); return; }
  const label = document.getElementById('dp_label').value.trim();
  const date  = document.getElementById('dp_date').value;
  if (!state.debtPayments) state.debtPayments = [];
  state.debtPayments.push({ id: uid(), label, amount, date });
  save(); renderJobs(); closeModal('debtPaymentModal');
}
function deleteDebtPayment(id) {
  if (!confirm('Remove this payment?')) return;
  state.debtPayments = (state.debtPayments || []).filter(p => p.id !== id);
  save(); renderJobs();
}

function toggleRepayment(id) {
  const j = state.jobs.find(j=>j.id===id);
  if (!j) return;
  j.repaymentMode = !j.repaymentMode;
  save(); renderJobs();
}
function toggleJob(id) {
  const j = state.jobs.find(j=>j.id===id);
  if (j) { j._expanded = !j._expanded; save(); renderJobs(); }
}
function cycleStatus(jobId, itemType, idx) {
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job||!job[itemType]||!job[itemType][idx]) return;
  const item = job[itemType][idx];
  const cycle = { pending:'invoiced', invoiced:'collected', collected:'pending' };
  item.status = cycle[item.status||'pending'];
  save(); renderJobs();
}
function toggleComplete(id) {
  const j = state.jobs.find(j=>j.id===id);
  if (j) { j.status = j.status==='complete'?'active':'complete'; save(); renderJobs(); }
}
function deleteJob(id) {
  if (!confirm('Delete this job? This cannot be undone.')) return;
  state.jobs = state.jobs.filter(j=>j.id!==id); save(); renderJobs();
}
function removeItem(jobId, key, idx) {
  const j = state.jobs.find(j=>j.id===jobId);
  if (j&&j[key]) { j[key].splice(idx,1); save(); renderJobs(); }
}

// â”€â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNotes(jobId) {
  notesJobId = jobId;
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job) return;
  document.getElementById('notesModalTitle').textContent = `Notes â€” ${job.name}`;
  document.getElementById('n_date').value = today();
  document.getElementById('n_text').value = '';
  renderNotesList();
  document.getElementById('notesModal').classList.remove('hidden');
}
function renderNotesList() {
  const job = state.jobs.find(j=>j.id===notesJobId);
  if (!job) return;
  const notes = (job.jobNotes||[]).slice().reverse();
  document.getElementById('notesList').innerHTML = notes.length
    ? notes.map(n=>`
      <div class="note-item">
        <div class="note-meta">
          <span class="note-date-label">${fmtDate(n.date)||n.date||'â€”'}</span>
          <div class="note-actions">
            <button class="btn btn-ghost btn-sm" onclick="openEditNote('${job.id}','${n.id}')">âœ</button>
            <button class="btn btn-danger btn-sm" onclick="deleteNote('${job.id}','${n.id}')">âœ•</button>
          </div>
        </div>
        <div class="note-text">${esc(n.text)}</div>
      </div>`).join('')
    : '<div style="color:var(--text3);font-size:17px;padding:8px 0 16px">No notes yet.</div>';
}
function saveNote() {
  const text = document.getElementById('n_text').value.trim();
  const date = document.getElementById('n_date').value;
  if (!text) { alert('Please enter a note.'); return; }
  const job = state.jobs.find(j=>j.id===notesJobId);
  if (!job) return;
  if (!job.jobNotes) job.jobNotes=[];
  job.jobNotes.push({ id:uid(), text, date });
  save(); document.getElementById('n_text').value=''; document.getElementById('n_date').value=today();
  renderNotesList(); renderJobs();
}
function deleteNote(jobId, noteId) {
  if (!confirm('Delete this note?')) return;
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job) return;
  job.jobNotes = (job.jobNotes||[]).filter(n=>n.id!==noteId);
  save(); renderNotesList(); renderJobs();
}
function openEditNote(jobId, noteId) {
  const job  = state.jobs.find(j=>j.id===jobId);
  if (!job) return;
  const note = (job.jobNotes||[]).find(n=>n.id===noteId);
  if (!note) return;
  editNoteCtx = { jobId, noteId };
  document.getElementById('en_date').value = note.date||'';
  document.getElementById('en_text').value = note.text||'';
  document.getElementById('editNoteModal').classList.remove('hidden');
}
function saveEditNote() {
  if (!editNoteCtx) return;
  const { jobId, noteId } = editNoteCtx;
  const job  = state.jobs.find(j=>j.id===jobId);
  if (!job) return;
  const note = (job.jobNotes||[]).find(n=>n.id===noteId);
  if (!note) return;
  note.text = document.getElementById('en_text').value.trim();
  note.date = document.getElementById('en_date').value;
  save(); closeModal('editNoteModal'); renderNotesList(); renderJobs();
}

// â”€â”€â”€ HOURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openHours(jobId) {
  hoursJobId = jobId;
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job) return;
  document.getElementById('hoursModalTitle').textContent = `Hours â€” ${job.name}`;
  document.getElementById('h_date').value  = today();
  document.getElementById('h_hours').value = '';
  document.getElementById('h_note').value  = '';
  renderHoursList();
  document.getElementById('hoursModal').classList.remove('hidden');
}
function renderHoursList() {
  const job = state.jobs.find(j=>j.id===hoursJobId);
  if (!job) return;
  const hours = job.hours||[];
  const total = hours.reduce((s,h)=>s+(h.hours||0),0);
  document.getElementById('hoursTotalBar').innerHTML = `
    <div class="hours-total-bar">
      <span style="font-family:var(--mono);font-size:15px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3)">Total Hours Logged</span>
      <span style="font-family:var(--mono);font-size:28px;font-weight:600;color:var(--accent)">${total}h</span>
    </div>`;
  const sorted = hours.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  document.getElementById('hoursList').innerHTML = sorted.length
    ? sorted.map(h=>`
      <div class="hours-item">
        <div>
          <div style="font-family:var(--mono);font-size:16px;color:var(--text3)">${fmtDate(h.date)||h.date||''}</div>
          ${h.note?`<div style="font-size:17px;color:var(--text2);margin-top:2px">${esc(h.note)}</div>`:''}
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-family:var(--mono);font-size:20px;font-weight:600;color:var(--accent)">${h.hours}h</span>
          <button class="btn btn-danger btn-sm" onclick="deleteHoursEntry('${h.id}')">âœ•</button>
        </div>
      </div>`).join('')
    : '<div style="color:var(--text3);font-size:17px;padding:8px 0 16px">No hours logged yet.</div>';
}
function saveHours() {
  const date  = document.getElementById('h_date').value;
  const hours = parseFloat(document.getElementById('h_hours').value);
  const note  = document.getElementById('h_note').value.trim();
  if (!hours||hours<=0) { alert('Please enter a valid number of hours.'); return; }
  const job = state.jobs.find(j=>j.id===hoursJobId);
  if (!job) return;
  if (!job.hours) job.hours=[];
  job.hours.push({ id:uid(), date, hours, note });
  save(); document.getElementById('h_hours').value=''; document.getElementById('h_note').value=''; document.getElementById('h_date').value=today();
  renderHoursList(); renderJobs();
}
function deleteHoursEntry(hId) {
  const job = state.jobs.find(j=>j.id===hoursJobId);
  if (!job) return;
  job.hours = (job.hours||[]).filter(h=>h.id!==hId);
  save(); renderHoursList(); renderJobs();
}

// â”€â”€â”€ JOB MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let milestoneCount = 0;
function openNewJobModal() {
  editingJobId = null;
  document.getElementById('jobModalTitle').textContent = 'New Job';
  document.getElementById('f_name').value = '';
  document.getElementById('f_quote').value = '';
  document.getElementById('f_date').value = today();
  document.getElementById('milestoneList').innerHTML = '';
  milestoneCount = 0;
  addMilestoneField('Deposit (50%)', 50);
  addMilestoneField('Rough-in (25%)', 25);
  addMilestoneField('Completion (25%)', 25);
  document.getElementById('jobModal').classList.remove('hidden');
}
function editJob(id) {
  const job = state.jobs.find(j=>j.id===id);
  if (!job) return;
  editingJobId = id;
  document.getElementById('jobModalTitle').textContent = 'Edit Job';
  document.getElementById('f_name').value  = job.name;
  document.getElementById('f_quote').value = job.quote;
  document.getElementById('f_date').value  = job.date||'';
  document.getElementById('milestoneList').innerHTML = '';
  milestoneCount = 0;
  (job.milestones||[]).forEach(m=>addMilestoneField(m.label,m.pct));
  document.getElementById('jobModal').classList.remove('hidden');
}
function addMilestoneField(label='', pct='') {
  milestoneCount++;
  const id = milestoneCount;
  const div = document.createElement('div');
  div.className = 'milestone-row'; div.id = `mrow_${id}`;
  div.innerHTML = `
    <input class="form-input" placeholder="Label" value="${label}" id="mlabel_${id}" style="flex:2" />
    <input class="form-input" placeholder="%" type="number" value="${pct}" id="mpct_${id}" style="flex:1;max-width:80px" oninput="updateMilestonePreview()" />
    <button class="btn btn-danger btn-sm" onclick="document.getElementById('mrow_${id}').remove();updateMilestonePreview()">âœ•</button>`;
  document.getElementById('milestoneList').appendChild(div);
  updateMilestonePreview();
}
function updateMilestonePreview() {
  let total=0;
  document.querySelectorAll('[id^="mpct_"]').forEach(el=>{total+=parseFloat(el.value)||0;});
  const err = document.getElementById('milestoneError');
  err.textContent = (Math.abs(total-100)>0.01&&total>0) ? `Milestones total ${total}% â€” must equal 100%` : '';
}
function saveJob() {
  const name  = document.getElementById('f_name').value.trim();
  const quote = parseFloat(document.getElementById('f_quote').value)||0;
  const date  = document.getElementById('f_date').value;
  if (!name) { alert('Please enter a client name.'); return; }
  const milestones=[]; let total=0;
  document.querySelectorAll('[id^="mpct_"]').forEach((el,i)=>{
    const pct = parseFloat(el.value)||0;
    const lbl = document.getElementById(`mlabel_${i+1}`)?.value||`Milestone ${i+1}`;
    milestones.push({label:lbl,pct,status:'pending'}); total+=pct;
  });
  if (milestones.length&&Math.abs(total-100)>0.01) { alert(`Milestone percentages add up to ${total}%, not 100%.`); return; }
  if (editingJobId) {
    const job = state.jobs.find(j=>j.id===editingJobId);
    if (job) {
      job.name=name; job.quote=quote; job.date=date;
      milestones.forEach((m,i)=>{ if(job.milestones[i]) m.status=job.milestones[i].status||'pending'; });
      job.milestones=milestones;
    }
  } else {
    state.jobs.push({ id:uid(), name, quote, date, status:'active',
      milestones, addOns:[], materials:[], advances:[], fees:[], jobNotes:[], hours:[], repaymentMode:false, _expanded:true });
  }
  save(); renderJobs(); closeModal('jobModal');
}

// â”€â”€â”€ ADD ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddItem(jobId, type) {
  addItemContext = { jobId, type };
  const en = esc(state.settings.empName||'Employee');
  document.getElementById('addItemTitle').textContent = {addon:'Add Add-on',material:'Add Material',advance:'Add Advance'}[type];
  let html='';
  if (type==='addon') {
    html=`<div class="form-group"><label class="form-label">Description</label><input class="form-input" id="ai_label" placeholder="e.g. Electrical add-on" /></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" id="ai_amount" type="number" step="0.01" placeholder="0.00" /></div>
        <div class="form-group"><label class="form-label">Date</label><input class="form-input" id="ai_date" type="date" value="${today()}" /></div>
      </div>`;
  } else if (type==='material') {
    html=`<div class="form-group"><label class="form-label">Description</label><input class="form-input" id="ai_label" placeholder="e.g. Home Depot - lumber" /></div>
      <div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" id="ai_amount" type="number" step="0.01" placeholder="0.00" /></div>
      <div class="form-group"><label class="form-label">Purchased by</label>
        <select class="form-input" id="ai_who"><option value="owner">Me</option><option value="emp">${en}</option></select>
      </div>`;
  } else if (type==='advance') {
    html=`<div class="form-group"><label class="form-label">Description / Note</label><input class="form-input" id="ai_label" placeholder="e.g. Weekly advance" /></div>
      <div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" id="ai_amount" type="number" step="0.01" placeholder="0.00" /></div>
      <div class="form-group"><label class="form-label">Date</label><input class="form-input" id="ai_date" type="date" value="${today()}" /></div>`;
  }
  document.getElementById('addItemForm').innerHTML = html;
  document.getElementById('addItemModal').classList.remove('hidden');
}
function saveItem() {
  if (!addItemContext) return;
  const { jobId, type } = addItemContext;
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job) return;
  const label  = document.getElementById('ai_label')?.value.trim()||'';
  const amount = parseFloat(document.getElementById('ai_amount')?.value)||0;
  if (amount<=0) { alert('Please enter a valid amount.'); return; }
  if (type==='addon') {
    const date = document.getElementById('ai_date')?.value||'';
    job.addOns.push({ id:uid(), label, amount, date, status:'pending' });
  } else if (type==='material') {
    const who = document.getElementById('ai_who').value;
    job.materials.push({ id:uid(), label, amount, who });
  } else if (type==='advance') {
    const date = document.getElementById('ai_date')?.value||'';
    job.advances.push({ id:uid(), label, amount, date });
  }
  save(); renderJobs(); closeModal('addItemModal');
}

// â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings() {
  document.getElementById('s_empName').value        = state.settings.empName||'Employee';
  document.getElementById('s_empShare').value       = state.settings.empShare;
  document.getElementById('s_feeRate').value        = state.settings.feeRate;
  document.getElementById('s_debtOriginal').value   = state.settings.debtOriginal||2256.58;
  document.getElementById('s_debtOwnerShare').value = state.settings.debtOwnerShare||0.50;
  document.getElementById('settingsModal').classList.remove('hidden');
}
function saveSettings() {
  state.settings.empName        = document.getElementById('s_empName').value.trim()||'Employee';
  state.settings.empShare       = parseFloat(document.getElementById('s_empShare').value)||0.66;
  state.settings.feeRate        = parseFloat(document.getElementById('s_feeRate').value)||0.026;
  state.settings.debtOriginal   = parseFloat(document.getElementById('s_debtOriginal').value)||0;
  state.settings.debtOwnerShare = parseFloat(document.getElementById('s_debtOwnerShare').value)||0.50;
  save(); renderJobs(); closeModal('settingsModal');
}

// â”€â”€â”€ TABS & MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById(`tab-${name}`).classList.add('active');
  if (name === 'schedule') renderSchedule();
}
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
document.querySelectorAll('.modal-overlay').forEach(el=>{
  el.addEventListener('click', e=>{ if(e.target===el) el.classList.add('hidden'); });
});


// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLogin() {
  const overlay = document.getElementById('loginOverlay');
  const grid = document.getElementById('userPickGrid');
  overlay.style.display = 'flex';
  document.getElementById('loginPin').value = '';
  document.getElementById('loginError').textContent = '';

  // Try auto-login from localStorage (persistent) or sessionStorage (session)
  const saved = localStorage.getItem('ehs_user_persist') || sessionStorage.getItem('ehs_user');
  if (saved) {
    try {
      const u = JSON.parse(saved);
      const match = state.users.find(x => x.id === u.id);
      if (match) {
        currentUser = { id: match.id, name: match.name, isAdmin: match.isAdmin };
        overlay.style.display = 'none';
        applyUserView();
        renderAll();
        return;
      }
    } catch(e) {}
  }

  // Render user picker
  grid.innerHTML = state.users.map(u => `
    <div class="user-pick-btn" id="upick_${u.id}" onclick="selectUser('${u.id}')">${esc(u.name)}</div>
  `).join('');

  // Auto-select if only one user
  if (state.users.length === 1) selectUser(state.users[0].id);
}

let selectedLoginUserId = null;
function selectUser(id) {
  selectedLoginUserId = id;
  document.querySelectorAll('.user-pick-btn').forEach(b => b.classList.remove('selected'));
  const el = document.getElementById('upick_' + id);
  if (el) el.classList.add('selected');
  document.getElementById('loginPin').focus();
}

function doLogin() {
  if (!selectedLoginUserId) { document.getElementById('loginError').textContent = 'Please select your name.'; return; }
  const pin = document.getElementById('loginPin').value;
  const user = state.users.find(u => u.id === selectedLoginUserId);
  if (!user) return;
  if (user.pin !== pin) { document.getElementById('loginError').textContent = 'Incorrect PIN.'; document.getElementById('loginPin').value=''; return; }
  currentUser = { id: user.id, name: user.name, isAdmin: user.isAdmin };
  const keepIn = document.getElementById('keepLoggedIn');
  if (keepIn && keepIn.checked) {
    localStorage.setItem('ehs_user_persist', JSON.stringify(currentUser));
  } else {
    sessionStorage.setItem('ehs_user', JSON.stringify(currentUser));
  }
  document.getElementById('loginOverlay').style.display = 'none';
  applyUserView();
  renderAll();
}

function signOut() {
  currentUser = null;
  selectedLoginUserId = null;
  sessionStorage.removeItem('ehs_user');
  localStorage.removeItem('ehs_user_persist');
  showLogin();
}

function applyUserView() {
  const isAdmin = currentUser && currentUser.isAdmin;
  // Header elements
  const lbl = document.getElementById('headerUserLabel');
  const sob = document.getElementById('signOutBtn');
  if (lbl) { lbl.textContent = currentUser ? currentUser.name : ''; lbl.style.display = 'inline'; }
  if (sob) sob.style.display = 'inline-block';

  // Admin-only header buttons
  ['exportData', 'importFile', 'openSettings', 'openNewJobModal'].forEach(() => {});
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });

  // Tabs: non-admin only sees schedule
  document.querySelectorAll('.job-tab').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });

  // Summary + debt panel
  document.getElementById('summaryCards').style.display = isAdmin ? '' : 'none';
  document.getElementById('debtPanel').style.display = isAdmin ? '' : 'none';

  if (!isAdmin) {
    switchTab('schedule', document.getElementById('schedTab'));
  }
}

function renderAll() {
  renderJobs();
  if (document.getElementById('tab-schedule').classList.contains('active')) {
    renderSchedule();
  }
}

// â”€â”€â”€ USER MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openUserMgmt() {
  renderUserList();
  document.getElementById('nu_name').value = '';
  document.getElementById('nu_pin').value = '';
  document.getElementById('nu_role').value = 'employee';
  document.getElementById('userMgmtModal').classList.remove('hidden');
}

function renderUserList() {
  const users = state.users || [];
  document.getElementById('userList').innerHTML = users.length
    ? users.map(u => `
      <div class="user-row">
        <div>
          <div class="user-row-name">${esc(u.name)}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span class="user-row-badge${u.isAdmin?'':' emp'}">${u.isAdmin?'Admin':'Employee'}</span>
          <button class="btn btn-ghost btn-sm" onclick="openResetPin('${u.id}')">Reset PIN</button>
          ${!u.isAdmin || users.filter(x=>x.isAdmin).length > 1
            ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Remove</button>`
            : ''}
        </div>
      </div>`).join('')
    : '<div style="color:var(--text3);font-size:14px">No users yet.</div>';
}

async function addUser() {
  const name = document.getElementById('nu_name').value.trim();
  const pin  = document.getElementById('nu_pin').value;
  const role = document.getElementById('nu_role').value;
  if (!name) { alert('Please enter a name.'); return; }
  if (!pin)  { alert('Please set a PIN.'); return; }
  if ((state.users||[]).find(u => u.name.toLowerCase() === name.toLowerCase())) {
    alert('A user with that name already exists.'); return;
  }
  if (!state.users) state.users = [];
  state.users.push({ id: uid(), name, pin, isAdmin: role === 'admin' });
  await save();
  renderUserList();
  document.getElementById('nu_name').value = '';
  document.getElementById('nu_pin').value = '';
}

async function deleteUser(id) {
  const u = state.users.find(x => x.id === id);
  if (!u) return;
  if (u.id === currentUser.id) { alert("You can't remove yourself."); return; }
  if (!confirm(`Remove user "${u.name}"?`)) return;
  state.users = state.users.filter(x => x.id !== id);
  await save();
  renderUserList();
}

function openResetPin(userId) {
  resetPinUserId = userId;
  const u = state.users.find(x => x.id === userId);
  document.getElementById('resetPinLabel').textContent = `New PIN for ${u ? u.name : 'user'}`;
  document.getElementById('rp_pin').value = '';
  document.getElementById('resetPinModal').classList.remove('hidden');
}

async function doResetPin() {
  const pin = document.getElementById('rp_pin').value;
  if (!pin) { alert('Please enter a PIN.'); return; }
  const u = state.users.find(x => x.id === resetPinUserId);
  if (!u) return;
  u.pin = pin;
  await save();
  closeModal('resetPinModal');
  renderUserList();
}

function openChangePin() {
  document.getElementById('cp_old').value = '';
  document.getElementById('cp_new').value = '';
  document.getElementById('cp_confirm').value = '';
  document.getElementById('changePinModal').classList.remove('hidden');
}

async function doChangePin() {
  const old = document.getElementById('cp_old').value;
  const nw  = document.getElementById('cp_new').value;
  const conf= document.getElementById('cp_confirm').value;
  const u = state.users.find(x => x.id === currentUser.id);
  if (!u) return;
  if (u.pin !== old) { alert('Current PIN is incorrect.'); return; }
  if (!nw) { alert('Please enter a new PIN.'); return; }
  if (nw !== conf) { alert('New PINs do not match.'); return; }
  u.pin = nw;
  await save();
  closeModal('changePinModal');
  alert('PIN updated!');
}

// â”€â”€â”€ SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSchedule() {
  const el = document.getElementById('scheduleContent');
  if (!el) return;
  const appts = (state.appointments || []).slice().sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
  const isAdmin = currentUser && currentUser.isAdmin;

  el.innerHTML = `
    <div class="sched-toolbar">
      <div class="sched-view-toggle">
        <button class="sched-view-btn${schedView==='list'?' active':''}" onclick="setSchedView('list')">List</button>
        <button class="sched-view-btn${schedView==='month'?' active':''}" onclick="setSchedView('month')">Month</button>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openAppt()">+ Appointment</button>
    </div>
    <div id="schedViewContent"></div>
  `;

  renderSchedView(appts);
}

function setSchedView(v) {
  if (v !== 'list' || !selectedDayFilter) selectedDayFilter = null;
  schedView = v;
  const appts = (state.appointments || []).slice().sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
  document.querySelectorAll('.sched-view-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === v));
  renderSchedView(appts);
}

function renderSchedView(appts) {
  const el = document.getElementById('schedViewContent');
  if (!el) return;
  if (schedView === 'list') el.innerHTML = renderListView(appts);
  else el.innerHTML = renderMonthView(appts);
}

function renderListView(appts) {
  const todayStr = today();
  // Mobile day filter: show only that day with a back button
  if (selectedDayFilter) {
    const dayAppts = appts.filter(a => a.date === selectedDayFilter);
    const backBtn = `<button class="btn btn-ghost btn-sm" style="margin-bottom:14px" onclick="selectedDayFilter=null;setSchedView('month')">â€¹ Back to calendar</button>`;
    const header = `<div style="font-family:var(--mono);font-size:13px;color:var(--text3);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.08em">${fmtDate(selectedDayFilter)}</div>`;
    const cards = dayAppts.length
      ? dayAppts.map(a => \`
        <div class="appt-card">
          <div style="flex:1;min-width:0">
            <div class="appt-name">\${esc(a.clientName||'')}</div>
            <div class="appt-meta">
              \${a.time?\`<span>ðŸ• \${fmtTime(a.time)}</span>\`:''}
              \${a.address?\`<span>ðŸ“ \${esc(a.address)}</span>\`:''}
            </div>
            \${a.notes?\`<div class="appt-notes">\${esc(a.notes)}</div>\`:''}
          </div>
          <div class="appt-actions">
            <button class="btn btn-ghost btn-sm" onclick="openAppt('\${a.id}')">âœ</button>
            <button class="btn btn-danger btn-sm" onclick="deleteAppt('\${a.id}')">âœ•</button>
          </div>
        </div>\`).join('')
      : '<div class="no-appts">No appointments on this day.</div>';
    return backBtn + header + cards + \`<button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="openApptOnDate('\${selectedDayFilter}')">+ Add on this day</button>\`;
  }
  const upcoming = appts.filter(a => a.date >= todayStr);
  const past = appts.filter(a => a.date < todayStr).reverse();
  const isAdmin = currentUser && currentUser.isAdmin;

  const apptHtml = (list, isPast) => list.length ? list.map(a => `
    <div class="appt-card${isPast?' past':''}">
      <div style="flex:1;min-width:0">
        <div class="appt-name">${esc(a.clientName||'')}</div>
        <div class="appt-meta">
          <span>ðŸ“… ${fmtDate(a.date)}</span>
          ${a.time?`<span>ðŸ• ${fmtTime(a.time)}</span>`:''}
          ${a.address?`<span>ðŸ“ ${esc(a.address)}</span>`:''}
        </div>
        ${a.notes?`<div class="appt-notes">${esc(a.notes)}</div>`:''}
      </div>
      <div class="appt-actions">
        <button class="btn btn-ghost btn-sm" onclick="openAppt('${a.id}')">âœ</button>
        <button class="btn btn-danger btn-sm" onclick="deleteAppt('${a.id}')">âœ•</button>
      </div>
    </div>`).join('') : '';

  const upcomingHtml = apptHtml(upcoming, false);
  const pastHtml = apptHtml(past, true);

  return `
    ${upcomingHtml || '<div class="no-appts">ðŸ“… No upcoming appointments.<br>Tap + Appointment to add one.</div>'}
    ${pastHtml ? `
      <div style="margin-top:24px;margin-bottom:12px;font-family:var(--mono);font-size:11px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3)">Past</div>
      ${pastHtml}` : ''}
  `;
}

function renderMonthView(appts) {
  const year = calYear, month = calMonth;
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const todayStr = today();

  // Build appt lookup by date
  const byDate = {};
  appts.forEach(a => { if (!byDate[a.date]) byDate[a.date] = []; byDate[a.date].push(a); });

  const dowLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let cells = '';

  // Prev month fill
  for (let i = firstDay - 1; i >= 0; i--) {
    const d = daysInPrev - i;
    cells += `<div class="cal-cell other-month"><div class="cal-day-num">${d}</div></div>`;
  }

  // Current month
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayAppts = byDate[dateStr] || [];
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === selectedCalDay;
    const pills = dayAppts.slice(0,3).map(a =>
      `<div class="cal-appt-pill" onclick="event.stopPropagation();openAppt('${a.id}')">${esc(a.clientName||'Appt')}</div>`
    ).join('');
    const more = dayAppts.length > 3 ? `<div class="cal-more">+${dayAppts.length-3} more</div>` : '';
    cells += `<div class="cal-cell${isToday?' today':''}${dayAppts.length?' has-appts':''}${isSelected?' today':''}"
      onclick="selectCalDay('${dateStr}')" style="${isSelected?'border-color:var(--accent)':''}">
      <div class="cal-day-num">${d}</div>
      ${pills}${more}
    </div>`;
  }

  // Next month fill
  const totalCells = firstDay + daysInMonth;
  const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let d = 1; d <= remaining; d++) {
    cells += `<div class="cal-cell other-month"><div class="cal-day-num">${d}</div></div>`;
  }

  // Day drawer
  let drawer = '';
  if (selectedCalDay) {
    const dayAppts = byDate[selectedCalDay] || [];
    drawer = `
      <div class="day-drawer">
        <div class="day-drawer-title">${fmtDate(selectedCalDay)}${dayAppts.length===0?' â€” No appointments':''}</div>
        ${dayAppts.map(a => `
          <div class="appt-card" style="margin-bottom:8px">
            <div style="flex:1">
              <div class="appt-name">${esc(a.clientName||'')}</div>
              <div class="appt-meta">
                ${a.time?`<span>ðŸ• ${fmtTime(a.time)}</span>`:''}
                ${a.address?`<span>ðŸ“ ${esc(a.address)}</span>`:''}
              </div>
              ${a.notes?`<div class="appt-notes">${esc(a.notes)}</div>`:''}
            </div>
            <div class="appt-actions">
              <button class="btn btn-ghost btn-sm" onclick="openAppt('${a.id}')">âœ</button>
              <button class="btn btn-danger btn-sm" onclick="deleteAppt('${a.id}')">âœ•</button>
            </div>
          </div>`).join('')}
        <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="openApptOnDate('${selectedCalDay}')">+ Add on this day</button>
      </div>`;
  }

  return `
    <div class="cal-nav">
      <button class="btn btn-ghost btn-sm" onclick="changeMonth(-1)">â€¹ Prev</button>
      <div class="cal-month-label">${monthNames[month]} ${year}</div>
      <button class="btn btn-ghost btn-sm" onclick="changeMonth(1)">Next â€º</button>
    </div>
    <div class="cal-grid">
      ${dowLabels.map(d=>`<div class="cal-dow">${d}</div>`).join('')}
      ${cells}
    </div>
    ${drawer}
  `;
}

function selectCalDay(dateStr) {
  // On mobile, switch to list view filtered to that day instead of drawer
  if (window.innerWidth <= 600) {
    selectedCalDay = dateStr;
    schedView = 'list';
    selectedDayFilter = dateStr;
    document.querySelectorAll('.sched-view-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === 'list'));
    const appts = (state.appointments||[]).slice().sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
    renderSchedView(appts);
    return;
  }
  selectedCalDay = selectedCalDay === dateStr ? null : dateStr;
  const appts = (state.appointments||[]).slice().sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  renderSchedView(appts);
}

function changeMonth(dir) {
  calMonth += dir;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  if (calMonth < 0)  { calMonth = 11; calYear--; }
  selectedCalDay = null;
  const appts = (state.appointments||[]).slice().sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  renderSchedView(appts);
}

function fmtTime(t) {
  if (!t) return '';
  const [h,m] = t.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const hr = h % 12 || 12;
  return `${hr}:${String(m).padStart(2,'0')} ${ampm}`;
}

// â”€â”€â”€ APPOINTMENT CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAppt(id) {
  editingApptId = id || null;
  const appt = id ? (state.appointments||[]).find(a=>a.id===id) : null;
  document.getElementById('apptModalTitle').textContent = appt ? 'Edit Appointment' : 'New Appointment';
  document.getElementById('ap_name').value    = appt ? (appt.clientName||'') : '';
  document.getElementById('ap_date').value    = appt ? (appt.date||'') : today();
  document.getElementById('ap_time').value    = appt ? (appt.time||'') : '';
  document.getElementById('ap_address').value = appt ? (appt.address||'') : '';
  document.getElementById('ap_notes').value   = appt ? (appt.notes||'') : '';
  document.getElementById('apptModal').classList.remove('hidden');
}

function openApptOnDate(dateStr) {
  openAppt();
  document.getElementById('ap_date').value = dateStr;
}

async function saveAppt() {
  const clientName = document.getElementById('ap_name').value.trim();
  const date       = document.getElementById('ap_date').value;
  if (!clientName) { alert('Please enter a client name.'); return; }
  if (!date)       { alert('Please select a date.'); return; }
  const appt = {
    clientName,
    date,
    time:    document.getElementById('ap_time').value,
    address: document.getElementById('ap_address').value.trim(),
    notes:   document.getElementById('ap_notes').value.trim(),
    createdBy: currentUser ? currentUser.id : ''
  };
  if (!state.appointments) state.appointments = [];
  if (editingApptId) {
    const idx = state.appointments.findIndex(a=>a.id===editingApptId);
    if (idx>=0) state.appointments[idx] = { ...state.appointments[idx], ...appt };
  } else {
    state.appointments.push({ id: uid(), ...appt });
  }
  await save();
  closeModal('apptModal');
  renderSchedule();
}

async function deleteAppt(id) {
  if (!confirm('Delete this appointment?')) return;
  state.appointments = (state.appointments||[]).filter(a=>a.id!==id);
  await save();
  renderSchedule();
}

// â”€â”€â”€ EXPORT / IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData() {
  const filename = `ehs-tracker-backup-${today()}.json`;
  const json = JSON.stringify(state, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (!confirm(`Import "${file.name}"? This will overwrite all current data.`)) {
    event.target.value = ''; return;
  }
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const imported = JSON.parse(e.target.result);
      if (!imported.jobs || !imported.settings) throw new Error('Invalid backup file.');
      state = migrateState(imported);
      await save();
      renderJobs();
      alert('Import successful!');
    } catch(err) {
      alert('Import failed: ' + err.message);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

load();
</script>
</body>
</html>
